---
   - stat: path=/var/run/zookeeper
     register: stat_pid
   
   - set_fact:
       pid: "{{ lookup('file', '/var/run/zookeeper') }}"
     when: stat_pid.stat.exists

   - stat: path=/proc/{{pid}}/
     register: stat_proc
     when: stat_pid.stat.exists

   - command: >
       daemonize -ae /var/log/zookeeper.error -o /var/log/zookeeper.out
       -p /var/run/zookeeper -l /var/lock/zookeeper -v
       /opt/kafka/bin/zookeeper-server-start.sh /opt/kafka/config/zookeeper.properties
     when: not stat_pid.stat.exists or not stat_proc.stat.exists

   - wait_for:
      port: 2181

   - stat: path=/var/run/kafka
     register: stat_pid

   - set_fact:
       pid: "{{ lookup('file', '/var/run/kafka') }}"
     when: stat_pid.stat.exists

   - stat: path=/proc/{{pid}}/
     register: stat_proc
     when: stat_pid.stat.exists

   - command: >
       daemonize -ae /var/log/kafka.error -o /var/log/kafka.out 
       -p /var/run/kafka -l /var/lock/kafka -v 
       /opt/kafka/bin/kafka-server-start.sh /opt/kafka/config/server.properties
     when: not stat_pid.stat.exists or not stat_proc.stat.exists

   - wait_for:
      port: 9092

   - wait_for:
      port: 9092
      state: absent
      timeout: 31536000 
